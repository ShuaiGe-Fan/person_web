# æ–‡ä»¶è·¯å¾„: .github/workflows/deploy.yml

name: Feifeigongzhu ç½‘ç«™éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ECS

# ... (on: å’Œ jobs: build-and-deploy: é…ç½®ä¸å˜)

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ... (æ­¥éª¤ 1, 2, 3, 4: Checkout, Setup Node, Install, Build ä¸å˜)
      
      # 4. æ„å»º Vue é¡¹ç›®
      - name: Build Vue project
        run: npm run build

      # =========================================================
      # ğŸ¯ æ­¥éª¤ 5: æ¸…ç†ç›®æ ‡ç›®å½•ï¼ˆæ‚¨è¯¢é—®çš„æ–°å¢æ­¥éª¤ï¼‰
      # =========================================================
      - name: Execute remote commands (Pre-clean)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          
          # è¿œç¨‹æ‰§è¡Œçš„å‘½ä»¤è„šæœ¬ï¼šæ¸…ç†æ—§æ–‡ä»¶
          script: |
            DEPLOY_PATH="/var/www/html" # ç›®æ ‡ç›®å½•
            echo "Cleaning up all files in $DEPLOY_PATH before transfer..."
            sudo rm -rf $DEPLOY_PATH/* # åˆ é™¤ /var/www/html/ ä¸‹çš„æ‰€æœ‰å†…å®¹
            echo "Old files removed."

      # =========================================================
      # ğŸ¯ æ­¥éª¤ 6: ä¼ è¾“æ–‡ä»¶ (åœ¨æ¸…ç†åè¿›è¡Œ)
      # =========================================================
      - name: Transfer build artifacts to ECS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          source: "dist/" 
          target: "/var/www/html" 
          
      # 7. åœ¨ ECS ä¸Šæ‰§è¡ŒæœåŠ¡é‡å¯
      - name: Execute remote commands (Restart Service)
        # ... (åç»­ä»£ç ä¸å˜)