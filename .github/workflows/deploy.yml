# æ–‡ä»¶è·¯å¾„: .github/workflows/deploy.yml

name: Feifeigongzhu ç½‘ç«™éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ECS

# è§¦å‘éƒ¨ç½²çš„æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯æ—¶æ‰§è¡Œ
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: 1. Checkout code
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: 2. Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. å®‰è£…ä¾èµ–
      - name: 3. Install dependencies
        run: npm install

      # 4. æ„å»º Vue é¡¹ç›®
      - name: 4. Build Vue project
        run: npm run build

      # 5. åœ¨ ECS ä¸Šæ‰§è¡Œæ¸…ç†æ“ä½œ (åœ¨æ–‡ä»¶ä¼ è¾“å‰æ¸…ç©ºç›®æ ‡ç›®å½•)
      - name: 5. Execute remote commands (Pre-clean Target Directory)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          
          # å¢å¼ºçš„æ¸…ç†è„šæœ¬
          script: |
            DEPLOY_PATH="/var/www/html" # ç›®æ ‡ç›®å½•
            echo "Cleaning up old files in $DEPLOY_PATH before transfer..."
            
            # ç¡®ä¿ç›®å½•å­˜åœ¨
            sudo mkdir -p $DEPLOY_PATH
            
            # å½»åº•æ¸…ç†ç›®æ ‡ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼ˆåŒ…æ‹¬éšè—æ–‡ä»¶ï¼‰
            sudo shopt -s dotglob
            sudo rm -rf $DEPLOY_PATH/*
            
            echo "Old files removed."

      # 6. ä¼ è¾“æ„å»ºäº§ç‰©åˆ°é˜¿é‡Œäº‘ ECS (ä½¿ç”¨ SCP)
     
      - name: 6. Transfer build artifacts to ECS (Using SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          # ğŸŒŸ ä¿®æ”¹ç‚¹ 1: ä¸Šä¼ æ•´ä¸ª dist æ–‡ä»¶å¤¹ï¼ˆä¸å¸¦æ–œæ æˆ–é€šé…ç¬¦ï¼‰
          source: "dist" 
          # ğŸŒŸ ä¿®æ”¹ç‚¹ 2: ç›®æ ‡æ”¹ä¸ºä¸€ä¸ªä¸´æ—¶çš„ã€å”¯ä¸€çš„è·¯å¾„
          target: "/tmp/feifeigongzhu_deploy"
          
      # 7. åœ¨ ECS ä¸Šæ‰§è¡Œæƒé™ä¿®å¤å’Œé‡å¯æœåŠ¡ (æœ€åä¸€æ­¥)
     # 7. åœ¨ ECS ä¸Šæ‰§è¡Œç§»åŠ¨æ–‡ä»¶ã€æƒé™ä¿®å¤å’Œé‡å¯æœåŠ¡ (æœ€åä¸€æ­¥)
      - name: 7. Execute remote commands (Move Files, Fix Permissions, and Restart Nginx)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          
          # è¿œç¨‹æ‰§è¡Œçš„å‘½ä»¤è„šæœ¬ï¼š
          script: |
            DEPLOY_PATH="/var/www/html"
            TEMP_PATH="/tmp/feifeigongzhu_deploy"
            
            # 1. ç¡®ä¿ç›®æ ‡ç›®å½•å·²æ¸…ç†ï¼ˆå¦‚æœæ­¥éª¤ 5 å¤±è´¥ï¼‰
            echo "Ensuring DEPLOY_PATH is clean..."
            sudo rm -rf $DEPLOY_PATH/*
            
            # 2. å°†ä¸´æ—¶ç›®å½•ä¸­çš„ dist/ å†…å®¹ç§»åŠ¨åˆ° /var/www/html
            echo "Moving files from temporary location to $DEPLOY_PATH..."
            # ä½¿ç”¨ cp -R å¤åˆ¶å†…å®¹ï¼ˆè€Œä¸æ˜¯ç›®å½•æœ¬èº«ï¼‰åˆ°ç›®æ ‡ç›®å½•
            # æ³¨æ„ cp å‘½ä»¤çš„è¯­æ³•ï¼šæºè·¯å¾„åé¢åŠ æ–œæ ï¼Œè¡¨ç¤ºå¤åˆ¶å†…å®¹
            sudo cp -R $TEMP_PATH/dist/. $DEPLOY_PATH/
            
            # 3. æ¸…ç†ä¸´æ—¶ç›®å½•
            echo "Cleaning up temporary directory $TEMP_PATH..."
            sudo rm -rf $TEMP_PATH
            
            # 4. ä¿®å¤æƒé™
            echo "Fixing file ownership and permissions..."
            sudo chown -R www-data:www-data $DEPLOY_PATH
            sudo find $DEPLOY_PATH -type d -exec chmod 755 {} \;
            sudo find $DEPLOY_PATH -type f -exec chmod 644 {} \;
            
            # 5. é‡å¯ Nginx
            echo "Restarting Nginx service..."
            sudo systemctl restart nginx
            echo "Deployment successful!"
        