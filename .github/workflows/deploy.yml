# 文件路径: .github/workflows/deploy.yml

name: Feifeigongzhu 网站部署到阿里云 ECS

# 触发部署的条件：推送到 main 分支时执行
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: 1. Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境
      - name: 2. Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # 建议使用稳定版本 20

      # 3. 安装依赖
      - name: 3. Install dependencies
        run: npm install

      # 4. 构建 Vue 项目
      - name: 4. Build Vue project
        run: npm run build

      # 5. 在 ECS 上执行清理操作 (在文件传输前清空目标目录)
      # 这是之前解决 "多了一层dist" 的关键步骤
      - name: 5. Execute remote commands (Pre-clean Target Directory)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          
          script: |
            DEPLOY_PATH="/var/www/html" # 目标目录
            echo "Cleaning up old files in $DEPLOY_PATH before transfer..."
            # 确保目标路径存在且清空内容
            sudo rm -rf $DEPLOY_PATH/*
            echo "Old files removed."

      # 6. 传输构建产物到阿里云 ECS (使用 SCP)
      # 确保传输的是 dist 目录里的内容到 /var/www/html 根目录
      - name: 6. Transfer build artifacts to ECS (Using SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          # 传输本地 dist 目录下的所有内容
          source: "dist/"
          # 服务器上的目标目录
          target: "/var/www/html"
          
      # 7. 在 ECS 上执行服务重启 (最后一步)
      - name: 7. Execute remote commands (Restart Nginx Service)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          
          # 远程执行的命令脚本：重启 Nginx
          script: |
            echo "Restarting Nginx service..."
            sudo systemctl restart nginx
            echo "Deployment successful!"