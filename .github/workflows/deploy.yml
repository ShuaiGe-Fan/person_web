# 文件路径: .github/workflows/deploy.yml

name: Feifeigongzhu 网站部署到阿里云 ECS

# 触发部署的条件：推送到 main 分支时执行
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: 1. Checkout code
        uses: actions/checkout@v4

      # 2. 设置 Node.js 环境
      - name: 2. Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. 安装依赖
      - name: 3. Install dependencies
        run: npm install

      # 4. 构建 Vue 项目
      - name: 4. Build Vue project
        run: npm run build

      # 5. 在 ECS 上执行清理操作 (在文件传输前清空目标目录)
      - name: 5. Execute remote commands (Pre-clean Target Directory)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          
          # 增强的清理脚本
          script: |
            DEPLOY_PATH="/var/www/html" # 目标目录
            echo "Cleaning up old files in $DEPLOY_PATH before transfer..."
            
            # 确保目录存在
            sudo mkdir -p $DEPLOY_PATH
            
            # 彻底清理目标目录下的所有文件和文件夹（包括隐藏文件）
            sudo shopt -s dotglob
            sudo rm -rf $DEPLOY_PATH/*
            
            echo "Old files removed."

      # 6. 传输构建产物到阿里云 ECS (使用 SCP)
      - name: 6. Transfer build artifacts to ECS (Using SCP)
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          # 传输本地 dist 目录下的所有内容
          source: "dist/*"
          # 服务器上的目标目录
          target: "/var/www/html"
          
      # 7. 在 ECS 上执行权限修复和重启服务 (最后一步)
      - name: 7. Execute remote commands (Fix Permissions and Restart Nginx)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ALIYUN_FEIFEIGONGZHU_HOST }}
          username: ${{ secrets.ALIYUN_FEIFEIGONGZHU_USERNAME }}
          key: ${{ secrets.ALIYUN_FEIFEIGONGZHU_SSH_KEY }}
          port: 22
          
          # 远程执行的命令脚本：修复权限和重启 Nginx
          script: |
            DEPLOY_PATH="/var/www/html"
            
            echo "Fixing file ownership and permissions..."
            # 1. 更改所有权给 Nginx 用户 (通常是 www-data)
            sudo chown -R www-data:www-data $DEPLOY_PATH
            # 2. 更改目录权限为 755 (允许组和其他用户读取和进入)
            sudo find $DEPLOY_PATH -type d -exec chmod 755 {} \;
            # 3. 更改文件权限为 644 (允许所有者和组用户读取)
            sudo find $DEPLOY_PATH -type f -exec chmod 644 {} \;
            
            echo "Restarting Nginx service..."
            sudo systemctl restart nginx
            echo "Deployment successful!"